<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        body {
            background-color: #f9f9f9;
        }
        .card-img-top {
            object-fit: cover;
            height: 180px;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .form-label {
            font-weight: 600;
        }
        .price-tag {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .rating {
            font-size: 0.9rem;
            color: #ffc107;
            font-weight: 600;
        }
    </style>
</head>
<body>

<!--  Navbar -->
<div th:replace="~{fragments/_navbar :: navbar}"></div>

<main class="container py-4">

    <!-- Flash Success Message -->
    <div th:if="${success}" class="alert alert-success text-center mt-3" th:text="${success}"></div>

    <!--  Alert messages -->
    <div th:if="${successMessage}" class="alert alert-success text-center" role="alert" th:text="${successMessage}"></div>
    <div th:if="${cartMessage}" class="alert alert-success text-center" role="alert" th:text="${cartMessage}"></div>

    <!--  Filter & Sort -->
    <form class="row gy-2 gx-3 align-items-end mb-4 shadow-sm p-3 rounded bg-light" method="get" th:action="@{/products}">
        <div class="col-md-3">
            <label class="form-label mb-1" for="q">Search</label>
            <input id="q" name="q" class="form-control" placeholder="Type a product name" th:value="${param.q}">
        </div>
        <div class="col-md-2">
            <label class="form-label mb-1" for="cat">Category</label>
            <select id="cat" name="category" class="form-select">
                <option value="" th:selected="${param.category == null}">All categories</option>
                <option th:each="c : ${categories}" th:value="${c}" th:text="${c}" th:selected="${param.category == c}"></option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label mb-1" for="max">Max Price (‚Ç™)</label>
            <input id="max" type="number" step="1" min="1" name="max" class="form-control" placeholder="e.g. 100" th:value="${param.max}">
        </div>
        <!-- ‚≠ê Sort By Rating -->
        <div class="col-md-3">
            <label class="form-label mb-1" for="sort">Sort By</label>
            <select id="sort" name="sort" class="form-select">
                <option value="">üîÑ Default Order</option>
                <option value="price_asc" th:selected="${sort == 'price_asc'}">üí∞ Price: Low to High</option>
                <option value="price_desc" th:selected="${sort == 'price_desc'}">üí∞ Price: High to Low</option>
                <option value="rating_desc" th:selected="${sort == 'rating_desc'}">‚≠ê Highest Rated First</option>
                <option value="rating_asc" th:selected="${sort == 'rating_asc'}">‚≠ê Lowest Rated First</option>
            </select>

        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary">üîç Filter</button>
        </div>
    </form>

    <!--  No products found -->
    <div th:if="${#lists.isEmpty(products)}" class="alert alert-warning text-center">
        üò¢ No products found matching your criteria.
    </div>

    <!--  Product Grid -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
        <div class="col" th:each="p : ${products}">
            <div class="card h-100 shadow-sm">
                <a th:href="@{/products/{id}(id=${p.id})}">
                    <img class="card-img-top"
                         th:src="${p.imageUrl == null ? '/images/placeholder.png' : (p.imageUrl.startsWith('http') ? p.imageUrl : '/' + p.imageUrl)}"
                         th:alt="${p.name}">
                </a>
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${p.name}">Product Name</h5>
                    <p class="card-text text-muted small" th:text="${p.description}">Description</p>

                    <!-- ‚≠ê Rating -->
                    <div th:if="${sortedByRating}" class="rating mb-1">
                        ‚≠ê
                        <span th:text="${#numbers.formatDecimal(avgRatings[p.id], 1, 1)}">0.0</span>/5
                    </div>

                    <div class="price-tag" th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 2, 'POINT')} + ' ‚Ç™'">0.00 ‚Ç™</div>

                    <!-- üö´ Sold Out -->
                    <div th:if="${p.stock == 0}" class="mt-2">
                        <span class="badge bg-danger px-3 py-2">üö´ Sold Out</span>
                    </div>

                    <!-- ‚úÖ User Actions -->
                    <div th:if="${#authorization.expression('hasRole(''USER'')')}" class="mt-3 d-flex flex-column gap-2">
                        <!-- Favorite Toggle -->
                        <form th:action="@{${p.favorite} ? '/favorites/remove/' + ${p.id} : '/favorites/add/' + ${p.id}}" method="get">
                            <button type="submit"
                                    th:class="'btn btn-sm ' + (${p.favorite} ? 'btn-danger' : 'btn-outline-danger')">
                                <span th:text="${p.favorite} ? '‚ùå Remove from Favorites' : 'ü§ç Add to Favorites'"></span>
                            </button>
                        </form>

                        <!-- Add to Cart -->
                        <div th:if="${p.stock > 0}">
                            <form th:action="@{/cart/add}" method="post" class="d-flex flex-column gap-2">
                                <input type="hidden" name="productId" th:value="${p.id}" />
                                <div class="d-flex gap-2">
                                    <input type="number" name="quantity" min="1" th:max="${p.stock}" value="1"
                                           class="form-control form-control-sm" style="width: 80px;">
                                    <input type="text" name="comment" placeholder="Optional comment"
                                           class="form-control form-control-sm" style="flex-grow: 1;">
                                </div>
                                <button type="submit" class="btn btn-sm btn-outline-primary mt-1">üõí Add to Cart</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
